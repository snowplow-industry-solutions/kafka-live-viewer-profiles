<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>README</title>
<link rel="stylesheet" href="./README.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./rouge-github.css">
</head>
<body class="article">
<div id="header">
<h1>README</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This lab runs Snowbridge using Docker and a transformation made by the script <code>script.&lt;number&gt;.js</code>.
So, you can specify the script to execute by running a shell script (<a href="run.sh" class="bare">run.sh</a>).</p>
</div>
<div class="paragraph">
<p>The output generated by Snowbridge is copied to <code>output.&lt;number&gt;.txt</code>.</p>
</div>
<div class="paragraph">
<p>Execute the <a href="run.sh" class="bare">run.sh</a> script and you will get more details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issue">Issue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Take a look at the order of events generated by Snowplow Micro when it was collected in the file <code>data.tsv</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./events-from-snowplow.sh <span class="o">&gt;</span> events-from-snowplow.sh.txt</code></pre>
</div>
</div>
<details>
<summary class="title">Output</summary>
<div class="content">
<div class="listingblock scrollable-block">
<div class="title">events-from-snowplow.sh.txt:</div>
<div class="content">
<pre>2024-11-16 13:33:29.170,15928a51-c999-4185-bf40-796886441149,play_event
2024-11-16 13:33:30.146,69bc9af1-72e2-4230-8e7e-f7ac708dd754,pause_event
2024-11-16 13:33:30.146,9f0ae951-fabd-4fe0-a2d7-b1c1c182111b,ad_break_start_event
2024-11-16 13:33:38.339,2688462e-cc38-469e-ab72-0bd16d25ee0a,ad_break_end_event
2024-11-16 13:33:38.601,2eb657f0-0777-40e8-ac69-e4fc762dd527,play_event
2024-11-16 13:33:53.338,1617ca18-7ed2-4ed4-a793-1382942f2a30,ping_event
2024-11-16 13:34:08.349,d9fd8a15-3548-4b9f-b0ea-a919eea71925,ad_break_start_event
2024-11-16 13:34:08.408,bc812c39-3002-4dfc-a17f-2966f96e0290,pause_event
2024-11-16 13:34:17.768,52428cd3-8441-462c-b85f-f1f99120db2c,ad_break_end_event
2024-11-16 13:34:18.039,6aa7e70c-1099-47f6-8c34-b9eb8277ee8d,play_event
2024-11-16 13:34:23.338,d4cb46c6-0e1a-4b9c-83ea-50b2788d733d,ping_event
2024-11-16 13:34:48.339,bcf526e0-7e9c-4edc-b9e1-0eb7f0fb6800,ad_break_start_event
2024-11-16 13:34:48.398,7621a504-287c-4ff3-884c-475fb4dd4857,pause_event
2024-11-16 13:34:52.978,a9890ee5-c439-4444-bdce-db149a937392,ad_break_end_event
2024-11-16 13:34:53.037,53b3fee7-f9e6-48af-ad44-2f62f114e4c1,play_event
2024-11-16 13:34:53.328,b6f6d8e0-b844-42bb-9f10-0ea448fde5b5,ping_event
2024-11-16 13:34:59.778,d895b0b3-43e1-450f-8155-6a493d61d9b5,pause_event
2024-11-16 13:35:23.338,8428f3e8-90fb-4278-aa4f-b70a94346347,ping_event</pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>You can observe that the order <code>collector_tstamp</code> (first field) is increasing as expected.</p>
</div>
<details>
<summary class="title">Click here to see some details about this script</summary>
<div class="content">
<div class="paragraph">
<p>Here is the source code:</p>
</div>
<div class="listingblock">
<div class="title"><a href="events-from-snowplow.sh" class="bare">events-from-snowplow.sh</a>:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c">#!/usr/bin/env bash</span>
<span class="nb">set</span> <span class="nt">-eou</span> pipefail
<span class="nb">cd</span> <span class="si">$(</span><span class="nb">dirname</span> <span class="nv">$0</span><span class="si">)</span>

<span class="nb">awk</span> <span class="nt">-F</span><span class="s1">':'</span> <span class="s1">'
/collector_tstamp/ {
    collector_tstamp = substr($0, index($0, $2))
    next
}
/event_id/ {
    event_id = substr($0, index($0, $2))
    next
}
/event_name/ {
    print collector_tstamp "," event_id "," substr($0, index($0, $2))
}'</span> data.tsv.txt |
<span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'(play_event|pause_event|ping_event|end_event|ad_break_start_event|ad_break_end_event)'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This scripts uses the file <code>data.tsv.txt</code> witch is generated from <code>data.tsv</code> by using the script <a href="data/tsv-debug.sh" class="bare">data/tsv-debug.sh</a>.</p>
</div>
</div>
</details>
<div class="paragraph">
<p>But, the order for <code>collecor_tstamp</code> was not replicated correctly in the output generated by Snowbridge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./events-from-snowbridge.sh <span class="o">&gt;</span> events-from-snowbridge.sh.txt</code></pre>
</div>
</div>
<details>
<summary class="title">Output</summary>
<div class="content">
<div class="listingblock scrollable-block">
<div class="title">events-from-snowbridge.sh.txt:</div>
<div class="content">
<pre>2024-11-16T13:34:08.408Z,bc812c39-3002-4dfc-a17f-2966f96e0290,pause_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,0,0,293,30.120879
2024-11-16T13:34:48.339Z,bcf526e0-7e9c-4edc-b9e1-0eb7f0fb6800,ad_break_start_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,1,0,60.674818
2024-11-16T13:33:38.601Z,2eb657f0-0777-40e8-ac69-e4fc762dd527,play_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,0,0,0,0.16254
2024-11-16T13:35:23.338Z,8428f3e8-90fb-4278-aa4f-b70a94346347,ping_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,3,0,67.502404
2024-11-16T13:34:52.978Z,a9890ee5-c439-4444-bdce-db149a937392,ad_break_end_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,3,0,60.69049
2024-11-16T13:34:59.778Z,d895b0b3-43e1-450f-8155-6a493d61d9b5,pause_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,3,0,67.502404
2024-11-16T13:34:53.037Z,53b3fee7-f9e6-48af-ad44-2f62f114e4c1,play_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,3,0,60.758767
2024-11-16T13:34:18.039Z,6aa7e70c-1099-47f6-8c34-b9eb8277ee8d,play_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,1,0,30.185941
2024-11-16T13:34:53.328Z,b6f6d8e0-b844-42bb-9f10-0ea448fde5b5,ping_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,3,0,60.960138
2024-11-16T13:33:30.146Z,9f0ae951-fabd-4fe0-a2d7-b1c1c182111b,ad_break_start_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,0,0,0,0
2024-11-16T13:34:17.768Z,52428cd3-8441-462c-b85f-f1f99120db2c,ad_break_end_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,1,0,30.120879
2024-11-16T13:34:08.349Z,d9fd8a15-3548-4b9f-b0ea-a919eea71925,ad_break_start_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,0,0,0,29.926184
2024-11-16T13:33:38.339Z,2688462e-cc38-469e-ab72-0bd16d25ee0a,ad_break_end_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,0,0,0,0.112652
2024-11-16T13:33:53.338Z,1617ca18-7ed2-4ed4-a793-1382942f2a30,ping_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,0,0,0,15.0301
2024-11-16T13:34:23.338Z,d4cb46c6-0e1a-4b9c-83ea-50b2788d733d,ping_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,1,0,35.425666
2024-11-16T13:34:48.398Z,7621a504-287c-4ff3-884c-475fb4dd4857,pause_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,1,1,285,60.69049
2024-11-16T13:33:29.17Z,15928a51-c999-4185-bf40-796886441149,play_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,0,0,0,0
2024-11-16T13:33:30.146Z,69bc9af1-72e2-4230-8e7e-f7ac708dd754,pause_event,143f9cb9-3db9-4e99-8d67-c8aea075d190,0,0,288,0.112652</pre>
</div>
</div>
</div>
</details>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is a serious issue because <a href="../../../live-viewer-backend/src/main/java/com/snowplowanalytics/liveviewerprofile/service/VideoStateMachine.java">a state machine that determines the video</a> status wonâ€™t work correctly without events occurring in order.
</td>
</tr>
</table>
</div>
<details>
<summary class="title">Click here to see some details about this script</summary>
<div class="content">
<div class="paragraph">
<p>Here is the code of the script above:</p>
</div>
<div class="listingblock">
<div class="title"><a href="events-from-snowbridge.sh" class="bare">events-from-snowbridge.sh</a>:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c">#!/usr/bin/env bash</span>
<span class="nb">set</span> <span class="nt">-eou</span> pipefail
<span class="nb">cd</span> <span class="si">$(</span><span class="nb">dirname</span> <span class="nv">$0</span><span class="si">)</span>

<span class="nb">cat</span> <span class="k">${</span><span class="nv">input</span><span class="k">:-</span><span class="nv">output</span><span class="p">.6.txt</span><span class="k">}</span> |
jq <span class="nt">-s</span> <span class="s1">'.[] | [ .collector_tstamp, .event_id, .event_name, .viewer_id, .adsClicked, .adsSkipped, .adId, .video_ts ] | @csv'</span> <span class="nt">-r</span> |
<span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'"'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It basically generates the output above from the file <code>output.6.txt</code>. This is the first two lines from this file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{"adsSkipped":0,"adId":"293","video_ts":30.120879,"collector_tstamp":"2024-11-16T13:34:08.408Z","event_id":"bc812c39-3002-4dfc-a17f-2966f96e0290","event_name":"pause_event","viewer_id":"143f9cb9-3db9-4e99-8d67-c8aea075d190","adsClicked":0}
{"video_ts":60.674818,"collector_tstamp":"2024-11-16T13:34:48.339Z","event_id":"bcf526e0-7e9c-4edc-b9e1-0eb7f0fb6800","event_name":"ad_break_start_event","viewer_id":"143f9cb9-3db9-4e99-8d67-c8aea075d190","adsClicked":1,"adsSkipped":1,"adId":0}</pre>
</div>
</div>
<div class="paragraph">
<p>This file contains only the <code>Data</code> part from the full output generated by Snowbridge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">        <span class="nb">echo </span>Saving output.txt to output.<span class="nv">$script_id</span>.txt.original
        <span class="nb">mv </span>output.txt output.<span class="nv">$script_id</span>.txt.original

        <span class="nb">echo </span>Generating an output.txt containing only the <span class="se">\"</span>Data<span class="se">\"</span> field ...
        <span class="nb">cut</span> <span class="nt">-d</span>, <span class="nt">-f5-</span> output.<span class="nv">$script_id</span>.txt.original | <span class="nb">sed</span> <span class="s1">'s/^Data://g'</span> <span class="o">&gt;</span> output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Snowbridge is called by <code>run.sh</code> this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">cat </span>data.tsv | docker run <span class="nt">--rm</span> <span class="nt">-i</span> <span class="se">\</span>
    <span class="nt">--env</span> <span class="nv">ACCEPT_LIMITED_USE_LICENSE</span><span class="o">=</span><span class="nb">yes</span> <span class="se">\</span>
    <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/config.hcl,target<span class="o">=</span>/tmp/config.hcl <span class="se">\</span>
    <span class="nt">--mount</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/script.js,target<span class="o">=</span>/tmp/script.js <span class="se">\</span>
    <span class="nv">$snowbridge_image</span> <span class="o">&gt;</span> output.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the content from file <a href="config.hcl" class="bare">config.hcl</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="hcl"><span class="nx">transform</span> <span class="p">{</span>
  <span class="nx">use</span> <span class="s2">"js"</span> <span class="p">{</span>
    <span class="nx">script_path</span> <span class="p">=</span> <span class="s2">"/tmp/script.js"</span>
    <span class="nx">snowplow_mode</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is the <a href="script.6.js" class="bare">script.6.js</a> file&#8217;s content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="javascript"><span class="kd">function</span> <span class="nx">main</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">spData</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">Data</span>
  <span class="kd">const</span> <span class="nx">includedEvents</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">unstruct</span><span class="dl">"</span><span class="p">]</span>
  <span class="kd">const</span> <span class="nx">includedEventNames</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">play_event</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">pause_event</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">ping_event</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">end_event</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">ad_break_start_event</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">ad_break_end_event</span><span class="dl">"</span><span class="p">]</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">includedEvents</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">spData</span><span class="p">.</span><span class="nx">event</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">includedEventNames</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">spData</span><span class="p">.</span><span class="nx">event_name</span><span class="p">)))</span> <span class="k">return</span> <span class="p">{</span> <span class="na">FilterOut</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">defaultValues</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">adsSkipped</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">adsClicked</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">contentWatched</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">adId</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">currentTime</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">paused</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="na">ended</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="p">{</span>
    <span class="nx">event_id</span><span class="p">,</span>
    <span class="nx">event_name</span><span class="p">,</span>
    <span class="nx">collector_tstamp</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">spData</span>

  <span class="kd">const</span> <span class="nx">user_id</span> <span class="o">=</span> <span class="nx">spData</span><span class="p">.</span><span class="nx">user_id</span> <span class="o">||</span> <span class="nx">spData</span><span class="p">.</span><span class="nx">domain_userid</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">PoC user</span><span class="dl">'</span>

  <span class="kd">const</span> <span class="p">{</span>
    <span class="nx">contentWatched</span> <span class="o">=</span> <span class="nx">defaultValues</span><span class="p">.</span><span class="nx">contentWatched</span><span class="p">,</span>
    <span class="nx">adsClicked</span> <span class="o">=</span> <span class="nx">defaultValues</span><span class="p">.</span><span class="nx">adsClicked</span><span class="p">,</span>
    <span class="nx">adsSkipped</span> <span class="o">=</span> <span class="nx">defaultValues</span><span class="p">.</span><span class="nx">adsSkipped</span><span class="p">,</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">spData</span><span class="p">.</span><span class="nx">contexts_com_snowplowanalytics_snowplow_media_session_1</span><span class="p">?.[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="p">{}</span>

  <span class="kd">const</span> <span class="p">{</span>
    <span class="nx">adId</span> <span class="o">=</span> <span class="nx">defaultValues</span><span class="p">.</span><span class="nx">adId</span><span class="p">,</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">spData</span><span class="p">.</span><span class="nx">contexts_com_snowplowanalytics_snowplow_media_ad_1</span><span class="p">?.[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="p">{}</span>

  <span class="kd">const</span> <span class="p">{</span>
    <span class="nx">currentTime</span> <span class="o">=</span> <span class="nx">defaultValues</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">,</span>
    <span class="nx">paused</span> <span class="o">=</span> <span class="nx">defaultValues</span><span class="p">.</span><span class="nx">paused</span><span class="p">,</span>
    <span class="nx">ended</span> <span class="o">=</span> <span class="nx">defaultValues</span><span class="p">.</span><span class="nx">ended</span><span class="p">,</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">spData</span><span class="p">.</span><span class="nx">contexts_com_snowplowanalytics_snowplow_media_player_2</span><span class="p">?.[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="p">{}</span>
  
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">Data</span><span class="p">:</span> <span class="p">{</span>
      <span class="nx">collector_tstamp</span><span class="p">,</span>
      <span class="nx">event_id</span><span class="p">,</span>
      <span class="nx">event_name</span><span class="p">,</span>
      <span class="na">viewer_id</span><span class="p">:</span> <span class="nx">user_id</span><span class="p">,</span>    
      <span class="nx">adsClicked</span><span class="p">,</span>
      <span class="nx">adsSkipped</span><span class="p">,</span>
      <span class="nx">adId</span><span class="p">,</span>
      <span class="na">video_ts</span><span class="p">:</span> <span class="nx">currentTime</span><span class="p">,</span>
      <span class="c1">//contentWatched,</span>
      <span class="c1">//paused,</span>
      <span class="c1">//ended,</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the command to generate the file <code>output.6.txt</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>./run.sh 6</code></pre>
</div>
</div>
</div>
</details>
</div>
</div>
</div>
</body>
</html>